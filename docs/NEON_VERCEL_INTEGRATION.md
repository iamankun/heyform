<!-- Generated by An Kun -->

# Neon + Vercel Integration Guide

This guide walks you through integrating Neon PostgreSQL database with your HeyForm application on Vercel.

## Prerequisites

- Vercel account with HeyForm project deployed
- Neon account (create at [neon.tech](https://neon.tech))
- Vercel CLI installed locally

## Step 1: Install Neon Integration on Vercel

1. Go to your Vercel project dashboard
2. Navigate to **Settings** → **Integrations**
3. Find and install the **Neon** integration
4. Follow the integration setup wizard

## Step 2: Configure Neon Database

### Create Database Schema

```sql
-- Run in Neon SQL Editor or via migration
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- Users table
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    email VARCHAR(255) NOT NULL UNIQUE,
    password_hash TEXT,
    first_name VARCHAR(100),
    last_name VARCHAR(100),
    avatar_url TEXT,
    is_email_verified BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    deleted_at TIMESTAMP
);

-- Additional tables...
-- (See /packages/server/src/migrations/0001_initial.sql for complete schema)
```

## Step 3: Environment Variables Setup

The Neon integration automatically adds these environment variables to your Vercel project:

### Auto-configured by Integration
- `DATABASE_URL` - Pooled connection string
- `DATABASE_URL_UNPOOLED` - Direct connection string
- `POSTGRES_URL` - Alternative format
- `POSTGRES_PRISMA_URL` - Prisma-optimized connection

### Manual Configuration Required
Add these in Vercel dashboard → Settings → Environment Variables:

```bash
# Stack Auth Configuration
NEXT_PUBLIC_STACK_PROJECT_ID=766ab62c-c23c-42f8-a86d-c54110398d2b
NEXT_PUBLIC_STACK_PUBLISHABLE_CLIENT_KEY=pck_tesnmnje0mtbetzmw1jcgach0s7x1sb5sydp1efhw0jjr
STACK_SECRET_SERVER_KEY=ssk_mq0vaygvt9g4bpcwr621pb2449133cw66bx34j1v0dpw0

# Application Settings
JWT_SECRET=your-super-secret-jwt-key
NODE_ENV=production
```

## Step 4: Database Migration

Create a migration script for deployment:

```bash
# In your local terminal
vercel env pull .env.local
pnpm run db:migrate
```

## Step 5: Verify Integration

### Test Database Connection
```typescript
// Test in your API route or server action
import { neon } from '@neondatabase/serverless'

const sql = neon(process.env.DATABASE_URL!)

export async function testConnection() {
  try {
    const result = await sql`SELECT current_database(), current_user`
    console.log('Database connected:', result[0])
    return true
  } catch (error) {
    console.error('Database connection failed:', error)
    return false
  }
}
```

## Step 6: Production Deployment

### Automatic Deployment
1. Push changes to your GitHub repository
2. Vercel automatically builds and deploys
3. Neon database is accessible via environment variables

### Manual Deployment
```bash
vercel --prod
```

## Monitoring and Maintenance

### Database Monitoring
- Monitor database usage in Neon dashboard
- Set up alerts for connection limits
- Review query performance regularly

### Connection Pooling
- Use `DATABASE_URL` for most operations (pooled)
- Use `DATABASE_URL_UNPOOLED` for migrations or long-running queries
- Monitor connection pool usage

## Troubleshooting

### Common Issues

**Connection Timeout**
```typescript
// Add connection timeout to your database config
const sql = neon(process.env.DATABASE_URL!, {
  connectionTimeout: 15000
})
```

**Pool Exhaustion**
```typescript
// Use unpooled connection for heavy operations
const sql_unpooled = neon(process.env.DATABASE_URL_UNPOOLED!)
```

**SSL Issues**
Ensure your connection string includes `?sslmode=require`

## Best Practices

1. **Use Pooled Connections** - For regular API requests
2. **Use Unpooled for Migrations** - For schema changes
3. **Monitor Usage** - Keep track of compute and storage usage
4. **Regular Backups** - Enable automated backups in Neon
5. **Environment Isolation** - Use separate databases for staging/production

## Links

- [Neon Documentation](https://neon.tech/docs)
- [Vercel Integration Guide](https://vercel.com/docs/storage/vercel-postgres)
- [HeyForm GitHub Repository](https://github.com/iamankun/heyform)
